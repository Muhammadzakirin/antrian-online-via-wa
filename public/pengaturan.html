<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengaturan WA Gateway</title>
    
    <script src="https://cdn.tailwindcss.com"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Sederhana untuk Halaman Pengaturan */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 450px;
            width: 90%;
            min-height: 650px; /* Tambahkan tinggi minimum */
        }

        h2 {
            color: #1a73e8;
            margin-bottom: 20px;
        }
        
        #wa-qr-status {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 25px;
            padding: 10px;
            border-radius: 6px;
            background-color: #e8f0fe;
            color: #1a73e8;
        }

        /* Styling untuk container QR Code agar di tengah */
        #qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
            border: 5px solid #eaeaea; 
            padding: 10px;
            border-radius: 5px;
            width: 320px;
            height: 320px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üîë Pengaturan Koneksi WhatsApp</h2>

    <div id="wa-qr-status" class="mt-3 text-base text-gray-700 font-medium">Status: Memuat status WA...</div>

    <div id="wa-connection-area-standalone" class="text-center mt-8">
        <button id="open-wa-lock-btn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold shadow-lg transition">
            üîê Masukkan Kunci Rahasia WA
        </button>
        
        <div id="wa-qr-display" class="mt-6 hidden flex flex-col items-center w-full">
             <div id="qrcode-container" class="mx-auto border-4 border-blue-500 p-4 rounded-lg bg-white shadow-2xl flex items-center justify-center">
                 <p>Menunggu Kode QR...</p>
             </div>
        </div>
    </div>


    <p style="color: #666; font-size: 0.9em; margin-top: 20px;">
        Jika Kode QR muncul, silakan scan menggunakan WhatsApp di ponsel Anda.
    </p>
</div>

<div id="secret-code-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[100] p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
        <div class="p-6 border-b">
            <h3 class="text-xl font-bold text-gray-800">üîí Masukkan Kunci Akses WA</h3>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-4">Kunci ini diperlukan untuk menautkan akun WhatsApp Puskesmas.</p>
            <input type="password" id="wa-secret-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md text-2xl tracking-widest text-center" maxlength="6" />
            <div id="wa-lock-message" class="mt-3 text-sm text-red-600 hidden"></div>
        </div>
        <div class="p-4 border-t text-right space-x-2">
            <button type="button" onclick="closeWaLockModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg">Batal</button>
            <button type="button" id="submit-wa-secret" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Buka Akses</button>
        </div>
    </div>
</div>
<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { initPengaturanModule } from "./pengaturan.module.js";
    
    // --- KONFIGURASI FIREBASE ---
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyCrfnerj9mYsivfDhGP65vEMRovyfsON_E",
        authDomain: "antrian-online-355c7.firebaseapp.com",
        projectId: "antrian-online-355c7",
        storageBucket: "antrian-online-355c7.firebasestorage.app",
        messagingSenderId: "1072172499150",
        appId: "1:1072172499150:web:1dd83762ae07ba61a3d09f",
        measurementId: "G-BMDTP9ES65"
    };

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);
    // Tidak ada auth.currentUser di sini, tapi auth object perlu dilewatkan
    const auth = getAuth(app); 
    
    // --- INSTANCE MODULE & INITIALIZATION ---
    const waModule = initPengaturanModule(db, auth);

    // Expose WA control functions globally (needed for onclick events)
    window.openWaLockModal = waModule.openWaLockModal;
    window.closeWaLockModal = waModule.closeWaLockModal;
    window.validateWaSecret = waModule.validateWaSecret;
    
    document.addEventListener('DOMContentLoaded', () => {
        // Panggil listener utama segera
        waModule.startWaStatusListener(); 
        
        // Panggil listener Socket.IO setelah DOM siap (untuk QR real-time)
        waModule.startWaSocketListener();
        
        // Setup tombol
        document.getElementById('open-wa-lock-btn').addEventListener('click', waModule.openWaLockModal);
        
        // Setup submit tombol di modal
        document.getElementById('submit-wa-secret').addEventListener('click', waModule.validateWaSecret);
    });
</script>

</body>
</html>